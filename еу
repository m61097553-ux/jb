package com.example.logging;

import ch.qos.logback.classic.pattern.MessageConverter;
import ch.qos.logback.classic.spi.ILoggingEvent;
import org.slf4j.helpers.MessageFormatter;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.util.*;

public class MaskedJsonMessageConverter extends MessageConverter {

    private static final ObjectMapper MAPPER = new ObjectMapper();

    // Пример: белый список шаблонов (как определять "это body")
    private static final Set<String> ALLOWED_TEMPLATES = Set.of(
            "Request body={}",
            "Response body={}",
            "Request received body={}",
            "Response sent body={}"
    );

    // твои правила
    private Map<String, FieldMasking> rules = Map.of();

    @Override
    public String convert(ILoggingEvent event) {

        // 1) Определяем: это "body"-лог? (по шаблону, НЕ по formattedMessage)
        String template = event.getMessage();
        if (template == null || !ALLOWED_TEMPLATES.contains(template)) {
            return event.getFormattedMessage(); // ничего не трогаем
        }

        Object[] args = event.getArgumentArray();
        if (args == null || args.length == 0) {
            return event.getFormattedMessage();
        }

        // 2) Ищем аргумент, который является JSON (String) или объектом (сериализуем в JSON)
        int jsonArgIndex = findJsonArgIndex(args);
        if (jsonArgIndex < 0) {
            return event.getFormattedMessage();
        }

        // 3) Маскируем только этот аргумент
        String maskedJson = maskArgToJson(args[jsonArgIndex]);
        if (maskedJson == null) {
            return event.getFormattedMessage();
        }

        Object[] newArgs = Arrays.copyOf(args, args.length);
        newArgs[jsonArgIndex] = maskedJson;

        // 4) Собираем итоговое сообщение по шаблону + аргументы
        return MessageFormatter.arrayFormat(template, newArgs).getMessage();
    }

    private int findJsonArgIndex(Object[] args) {
        for (int i = 0; i < args.length; i++) {
            Object a = args[i];
            if (a == null) continue;

            // если это String и похоже на JSON
            if (a instanceof String s) {
                String t = s.trim();
                if ((t.startsWith("{") && t.endsWith("}")) || (t.startsWith("[") && t.endsWith("]"))) {
                    return i;
                }
            } else {
                // любой объект можно сериализовать (часто это request/response DTO)
                return i;
            }
        }
        return -1;
    }

    private String maskArgToJson(Object arg) {
        try {
            JsonNode node;

            if (arg instanceof String s) {
                node = MAPPER.readTree(s);      // строка уже JSON
            } else {
                node = MAPPER.valueToTree(arg); // объект -> JsonNode
            }

            // TODO: применить маскирование по rules:
            // applyMasking(node, rules);

            return MAPPER.writeValueAsString(node);
        } catch (Exception e) {
            return null;
        }
    }
}
